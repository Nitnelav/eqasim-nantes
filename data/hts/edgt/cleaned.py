from tqdm import tqdm
import pandas as pd
import numpy as np
import data.hts.hts as hts

"""
This stage cleans the regional HTS.
"""

def configure(context):
    context.stage("data.hts.edgt.raw")

INCOME_CLASS_BOUNDS = [800, 1200, 1600, 2000, 2400, 3000, 3500, 4500, 5500, 1e6]

PURPOSE_MAP = {
    "home" : [1, 2, 3],
    "work" : [11, 12, 13] + [81],
    "leisure" : [51, 52, 53, 54],
    "education" : [21, 22, 23, 24, 25, 26, 27, 28, 29],
    "shop" : [30, 31, 32, 33, 34, 35, 36, 37, 38, 39] + [44] + [82],
    "other" : [41, 43, 45, 61, 62, 63, 64, 71, 72, 73, 74] + [91]
}

MODES_MAP = {
    "pt" : [30, 32, 34, 35, 36, 37, 38, 39, 41, 42, 52, 53, 72, 73, 91],
    "car" : [13, 15, 21] + [71, 81, 82, 92, 94, 95],
    "car_passenger" : [14, 16, 22, 61],
    "bike" : [11, 12, 19, 93],
    "walk" : [],
    # "other" : [71, 81, 82, 92, 94, 95]
}

ZONES_MAP = {
    "001001": "44109",
    "001002": "44109",
    "002001": "44109",
    "002002": "44109",
    "002003": "44109",
    "002004": "44109",
    "003001": "44109",
    "003002": "44109",
    "003003": "44109",
    "004001": "44109",
    "004002": "44109",
    "004003": "44109",
    "004004": "44109",
    "004005": "44109",
    "004006": "44109",
    "004007": "44109",
    "005001": "44109",
    "005002": "44109",
    "005003": "44109",
    "005004": "44109",
    "006001": "44109",
    "006002": "44109",
    "006003": "44109",
    "006004": "44109",
    "006005": "44109",
    "006006": "44109",
    "007001": "44109",
    "007002": "44109",
    "007003": "44109",
    "007004": "44109",
    "007005": "44109",
    "007006": "44109",
    "008001": "44109",
    "008002": "44109",
    "008003": "44109",
    "008004": "44109",
    "008005": "44109",
    "009001": "44109",
    "009002": "44109",
    "009003": "44109",
    "009004": "44109",
    "009005": "44109",
    "010001": "44109",
    "010002": "44109",
    "011001": "44109",
    "011002": "44109",
    "011003": "44109",
    "011004": "44109",
    "012001": "44109",
    "012002": "44109",
    "012003": "44109",
    "012004": "44109",
    "012005": "44109",
    "013001": "44109",
    "013002": "44109",
    "013003": "44109",
    "014001": "44109",
    "014002": "44109",
    "014003": "44109",
    "014004": "44109",
    "014005": "44109",
    "014006": "44109",
    "014007": "44109",
    "015001": "44109",
    "015002": "44109",
    "015003": "44109",
    "015004": "44109",
    "016001": "44109",
    "016002": "44109",
    "016003": "44109",
    "016004": "44109",
    "016005": "44109",
    "016006": "44109",
    "017001": "44109",
    "017002": "44109",
    "017003": "44109",
    "017004": "44109",
    "017005": "44109",
    "017006": "44109",
    "017007": "44109",
    "017008": "44109",
    "017009": "44109",
    "018001": "44109",
    "018002": "44109",
    "018003": "44109",
    "018004": "44109",
    "018005": "44109",
    "018006": "44109",
    "019001": "44109",
    "019002": "44109",
    "019003": "44109",
    "019004": "44109",
    "019005": "44109",
    "019006": "44109",
    "019007": "44109",
    "020001": "44109",
    "020002": "44109",
    "020003": "44109",
    "020004": "44109",
    "020005": "44109",
    "020006": "44109",
    "020007": "44109",
    "020008": "44109",
    "020009": "44109",
    "021001": "44190",
    "021002": "44190",
    "021003": "44190",
    "021004": "44190",
    "021005": "44190",
    "021006": "44190",
    "021007": "44190",
    "021008": "44190",
    "021009": "44190",
    "021010": "44190",
    "021011": "44190",
    "021012": "44190",
    "022001": "44190",
    "022002": "44190",
    "022003": "44190",
    "022004": "44190",
    "022005": "44190",
    "022006": "44190",
    "022007": "44190",
    "022008": "44190",
    "022009": "44190",
    "023001": "44109",
    "023002": "44109",
    "023003": "44109",
    "023004": "44109",
    "023005": "44109",
    "023006": "44109",
    "023007": "44109",
    "023008": "44109",
    "023009": "44109",
    "023010": "44109",
    "023011": "44109",
    "024001": "44143",
    "024002": "44143",
    "024003": "44143",
    "024004": "44143",
    "025001": "44162",
    "025002": "44162",
    "025003": "44162",
    "025004": "44162",
    "025005": "44162",
    "025006": "44162",
    "025007": "44162",
    "025008": "44162",
    "025009": "44162",
    "025010": "44162",
    "025011": "44162",
    "026001": "44162",
    "026002": "44162",
    "026003": "44162",
    "026004": "44162",
    "026005": "44162",
    "026006": "44162",
    "027001": "44162",
    "027002": "44162",
    "027003": "44162",
    "027004": "44162",
    "027005": "44162",
    "027006": "44162",
    "027007": "44162",
    "027008": "44162",
    "028001": "44114",
    "028002": "44114",
    "028003": "44114",
    "028004": "44114",
    "028005": "44114",
    "028006": "44114",
    "028007": "44114",
    "028008": "44114",
    "028009": "44114",
    "029001": "44109",
    "029002": "44109",
    "029003": "44109",
    "029004": "44114",
    "029005": "44114",
    "029006": "44114",
    "030001": "44109",
    "030002": "44109",
    "030003": "44109",
    "030004": "44109",
    "030005": "44109",
    "030006": "44109",
    "030007": "44109",
    "030008": "44109",
    "030009": "44109",
    "030010": "44109",
    "030011": "44109",
    "030012": "44109",
    "031001": "44109",
    "031002": "44109",
    "031003": "44109",
    "031004": "44109",
    "031005": "44109",
    "031006": "44109",
    "031007": "44109",
    "031008": "44109",
    "031009": "44109",
    "031010": "44109",
    "031011": "44109",
    "032001": "44143",
    "032002": "44143",
    "032003": "44143",
    "033001": "44074",
    "033002": "44074",
    "033003": "44074",
    "033004": "44074",
    "033005": "44162",
    "033006": "44162",
    "033007": "44162",
    "033008": "44162",
    "034001": "44162",
    "034002": "44162",
    "034003": "44162",
    "034004": "44162",
    "034005": "44162",
    "034006": "44162",
    "034007": "44162",
    "034008": "44162",
    "035001": "44114",
    "035002": "44114",
    "035003": "44114",
    "035004": "44114",
    "035005": "44114",
    "035006": "44114",
    "035007": "44114",
    "035008": "44114",
    "035009": "44194",
    "035010": "44194",
    "035011": "44194",
    "035012": "44194",
    "035013": "44194",
    "036001": "44035",
    "036002": "44035",
    "036003": "44035",
    "036004": "44035",
    "036005": "44035",
    "036006": "44035",
    "036007": "44035",
    "036008": "44035",
    "036009": "44035",
    "036010": "44035",
    "036011": "44035",
    "036012": "44035",
    "036013": "44035",
    "037001": "44035",
    "037002": "44035",
    "037003": "44035",
    "037004": "44035",
    "037005": "44035",
    "038001": "44026",
    "038002": "44026",
    "038003": "44026",
    "038004": "44026",
    "038005": "44026",
    "038006": "44026",
    "038007": "44026",
    "038008": "44026",
    "038009": "44026",
    "038010": "44026",
    "038011": "44026",
    "038012": "44026",
    "038013": "44026",
    "038014": "44026",
    "038015": "44026",
    "039001": "44172",
    "039002": "44172",
    "039003": "44172",
    "039004": "44172",
    "039005": "44172",
    "039006": "44172",
    "039007": "44172",
    "039008": "44172",
    "039009": "44172",
    "039010": "44172",
    "039011": "44172",
    "039012": "44204",
    "039013": "44204",
    "039014": "44204",
    "040001": "44026",
    "040002": "44026",
    "040003": "44094",
    "040004": "44094",
    "040005": "44204",
    "040006": "44204",
    "041001": "44009",
    "041002": "44009",
    "041003": "44009",
    "041004": "44009",
    "041005": "44009",
    "041006": "44009",
    "041007": "44009",
    "042001": "44215",
    "042002": "44215",
    "042003": "44215",
    "042004": "44215",
    "042005": "44215",
    "042006": "44215",
    "042007": "44215",
    "043001": "44215",
    "043002": "44215",
    "043003": "44215",
    "043004": "44215",
    "043005": "44215",
    "043006": "44215",
    "044001": "44198",
    "044002": "44198",
    "044003": "44198",
    "044004": "44198",
    "044005": "44198",
    "044006": "44198",
    "044007": "44198",
    "044008": "44198",
    "044009": "44198",
    "044010": "44215",
    "044011": "44215",
    "045001": "44143",
    "045002": "44143",
    "045003": "44143",
    "046001": "44143",
    "046002": "44143",
    "046003": "44143",
    "046004": "44143",
    "046005": "44143",
    "046006": "44143",
    "046007": "44143",
    "047001": "44020",
    "047002": "44020",
    "047003": "44020",
    "047004": "44020",
    "047005": "44020",
    "047006": "44020",
    "047007": "44020",
    "047008": "44020",
    "047009": "44020",
    "047010": "44020",
    "047011": "44020",
    "047012": "44020",
    "047013": "44109",
    "047014": "44109",
    "047015": "44109",
    "047016": "44109",
    "048001": "44020",
    "048002": "44020",
    "048003": "44020",
    "048004": "44020",
    "048005": "44020",
    "048006": "44020",
    "048007": "44020",
    "048008": "44020",
    "048009": "44020",
    "049001": "44018",
    "049002": "44018",
    "049003": "44018",
    "049004": "44018",
    "049005": "44018",
    "049006": "44018",
    "049007": "44018",
    "049008": "44018",
    "049009": "44018",
    "049010": "44018",
    "049011": "44150",
    "049012": "44150",
    "049013": "44150",
    "049014": "44150",
    "050001": "44024",
    "050002": "44024",
    "050003": "44024",
    "050004": "44024",
    "050005": "44120",
    "050006": "44120",
    "050007": "44120",
    "050008": "44120",
    "050009": "44171",
    "050010": "44171",
    "051001": "44101",
    "051002": "44101",
    "051003": "44101",
    "051004": "44101",
    "051005": "44166",
    "051006": "44166",
    "051007": "44166",
    "051008": "44166",
    "051009": "44166",
    "051010": "44166",
    "052001": "44047",
    "052002": "44047",
    "052003": "44047",
    "052004": "44047",
    "052005": "44047",
    "052006": "44047",
    "052007": "44047",
    "052008": "44047",
    "053001": "44047",
    "053002": "44047",
    "053003": "44047",
    "053004": "44047",
    "053005": "44047",
    "053006": "44114",
    "053007": "44114",
    "053008": "44114",
    "053009": "44114",
    "053010": "44162",
    "053011": "44162",
    "053012": "44162",
    "053013": "44162",
    "053014": "44162",
    "053015": "44162",
    "053016": "44162",
    "053017": "44162",
    "053018": "44194",
    "053019": "44194",
    "053020": "44194",
    "053021": "44194",
    "053022": "44194",
    "101001": "44183",
    "101002": "44183",
    "101003": "44006",
    "101004": "44006",
    "101005": "56155",
    "101006": "56155",
    "101007": "56030",
    "101008": "56030",
    "101009": "56058",
    "101010": "56058",
    "102001": "44211",
    "102002": "44211",
    "102003": "44125",
    "102004": "44125",
    "102005": "44097",
    "102006": "44097",
    "102007": "44097",
    "103001": "44049",
    "103002": "44049",
    "103003": "44010",
    "103004": "44010",
    "103005": "44135",
    "103006": "44135",
    "104001": "44055",
    "104002": "44055",
    "104003": "44055",
    "104004": "44055",
    "105001": "44055",
    "105002": "44055",
    "106001": "44069",
    "106002": "44069",
    "106003": "44069",
    "106004": "44069",
    "107001": "44069",
    "107002": "44069",
    "107003": "44069",
    "108001": "44072",
    "108002": "44072",
    "108003": "44072",
    "108004": "44175",
    "108005": "44175",
    "109001": "44176",
    "109002": "44176",
    "109003": "44168",
    "109004": "44168",
    "109005": "44030",
    "109006": "44030",
    "110001": "44184",
    "110002": "44184",
    "110003": "44151",
    "110004": "44151",
    "111001": "44132",
    "111002": "44132",
    "111003": "44132",
    "111004": "44132",
    "112001": "44184",
    "112002": "44184",
    "112003": "44184",
    "112004": "44184",
    "113001": "44184",
    "113002": "44184",
    "113003": "44184",
    "113004": "44184",
    "113005": "44184",
    "114001": "44184",
    "114002": "44184",
    "114003": "44184",
    "114004": "44184",
    "115001": "44184",
    "115002": "44184",
    "115003": "44184",
    "116001": "44184",
    "116002": "44184",
    "116003": "44184",
    "116004": "44184",
    "117001": "44184",
    "117002": "44184",
    "117003": "44184",
    "118001": "44184",
    "118002": "44184",
    "118003": "44184",
    "118004": "44184",
    "119001": "44184",
    "119002": "44184",
    "119003": "44184",
    "119004": "44184",
    "119005": "44184",
    "119006": "44184",
    "120001": "44210",
    "120002": "44210",
    "120003": "44210",
    "121001": "44103",
    "121002": "44103",
    "121003": "44103",
    "122001": "44013",
    "122002": "44013",
    "122003": "44052",
    "122004": "44052",
    "122005": "44052",
    "123001": "44129",
    "123002": "44129",
    "123003": "44053",
    "123004": "44053",
    "124001": "44050",
    "124002": "44050",
    "124003": "44189",
    "124004": "44189",
    "124005": "44098",
    "124006": "44098",
    "125001": "44152",
    "125002": "44152",
    "125003": "44161",
    "125004": "44161",
    "125005": "44196",
    "125006": "44196",
    "125007": "44068",
    "125008": "44068",
    "126001": "44139",
    "126002": "44139",
    "126003": "44025",
    "126004": "44025",
    "126005": "44137",
    "126006": "44137",
    "127001": "44195",
    "127002": "44195",
    "127003": "44195",
    "127004": "44195",
    "127005": "44195",
    "128001": "44033",
    "128002": "44033",
    "128003": "44080",
    "128004": "44080",
    "128005": "44019",
    "128006": "44019",
    "128007": "44089",
    "128008": "44089",
    "129001": "44061",
    "129002": "44061",
    "129003": "44192",
    "129004": "44192",
    "129005": "44116",
    "129006": "44116",
    "130001": "44046",
    "130002": "44046",
    "130003": "44187",
    "130004": "44187",
    "131001": "44154",
    "131002": "44154",
    "131003": "44154",
    "132001": "44182",
    "132002": "44182",
    "132003": "44126",
    "132004": "44126",
    "132005": "44136",
    "132006": "44136",
    "132007": "44012",
    "132008": "44012",
    "132009": "44106",
    "132010": "44106",
    "133001": "44131",
    "133002": "44131",
    "133003": "44131",
    "133004": "44131",
    "134001": "44038",
    "134002": "44038",
    "134003": "44005",
    "134004": "44005",
    "135001": "44040",
    "135002": "44040",
    "135003": "44220",
    "135004": "44220",
    "135005": "44145",
    "135006": "44145",
    "135007": "44039",
    "135008": "44039",
    "135009": "44133",
    "135010": "44133",
    "136001": "44164",
    "136002": "44164",
    "136003": "44186",
    "136004": "44186",
    "200001": "44045",
    "200002": "44045",
    "200003": "44045",
    "200004": "44045",
    "200005": "44158",
    "200006": "44158",
    "200007": "44158",
    "200008": "44158",
    "200009": "44158",
    "200010": "44203",
    "201001": "44056",
    "201002": "44056",
    "201003": "44056",
    "201004": "44111",
    "201005": "44111",
    "201006": "44111",
    "201007": "44217",
    "201008": "44217",
    "201009": "44217",
    "201010": "44217",
    "201011": "44217",
    "201012": "44217",
    "201013": "44217",
    "202001": "44066",
    "202002": "44066",
    "202003": "44066",
    "202004": "44073",
    "202005": "44073",
    "202006": "44073",
    "202007": "44209",
    "202008": "44209",
    "202009": "44209",
    "202010": "44209",
    "203001": "44027",
    "203002": "44027",
    "203003": "44110",
    "203004": "44110",
    "203005": "44110",
    "203006": "44110",
    "203007": "44205",
    "203008": "44205",
    "203009": "44205",
    "204001": "44122",
    "204002": "44122",
    "204003": "44179",
    "204004": "44179",
    "204005": "44201",
    "204006": "44201",
    "204007": "44201",
    "204008": "44201",
    "204009": "44201",
    "204010": "44201",
    "205001": "44015",
    "205002": "44015",
    "205003": "44015",
    "205004": "44023",
    "205005": "44023",
    "205006": "44062",
    "205007": "44221",
    "205008": "44221",
    "206001": "44044",
    "206002": "44044",
    "206003": "44067",
    "206004": "44067",
    "206005": "44067",
    "206006": "44123",
    "206007": "44123",
    "206008": "44128",
    "206009": "44128",
    "206010": "44128",
    "207001": "44007",
    "207002": "44007",
    "207003": "44057",
    "207004": "44057",
    "207005": "44092",
    "207006": "44092",
    "207007": "44185",
    "207008": "44185",
    "208001": "44001",
    "208002": "44001",
    "208003": "44113",
    "208004": "44113",
    "208005": "44113",
    "208006": "44138",
    "208007": "44138",
    "208008": "44138",
    "208009": "44149",
    "208010": "44149",
    "208011": "44208",
    "208012": "44208",
    "208013": "44214",
    "208014": "44214",
    "208015": "44224",
    "209001": "44051",
    "209002": "44051",
    "209003": "44051",
    "209004": "44076",
    "209005": "44076",
    "209006": "44086",
    "209007": "44086",
    "209008": "44091",
    "209009": "44091",
    "209010": "44105",
    "209011": "44193",
    "209012": "44193",
    "209013": "44197",
    "209014": "44197",
    "210001": "44036",
    "210002": "44036",
    "210003": "44036",
    "210004": "44036",
    "210005": "44036",
    "210006": "44036",
    "210007": "44036",
    "211001": "44054",
    "211002": "44054",
    "211003": "44054",
    "211004": "44058",
    "211005": "44058",
    "211006": "44085",
    "211007": "44085",
    "211008": "44112",
    "211009": "44146",
    "211010": "44146",
    "211011": "44148",
    "211012": "44148",
    "211013": "44153",
    "211014": "44153",
    "211015": "44199",
    "211016": "44199",
    "211017": "44199",
    "211018": "44200",
    "211019": "44200",
    "211020": "44218",
    "211021": "44218",
    "212001": "44031",
    "212002": "44065",
    "212003": "44065",
    "212004": "44075",
    "212005": "44075",
    "212006": "44078",
    "212007": "44095",
    "212008": "44095",
    "212009": "44099",
    "212010": "44099",
    "212011": "44121",
    "212012": "44170",
    "212013": "44170",
    "213001": "44017",
    "213002": "44093",
    "213003": "44093",
    "213004": "44118",
    "213005": "44118",
    "213006": "44124",
    "213007": "44124",
    "213008": "44134",
    "213009": "44134",
    "213010": "44180",
    "213011": "44180",
    "213012": "44180",
    "213013": "44191",
    "213014": "44191",
    "213015": "44219",
    "213016": "44219",
    "214001": "44077",
    "214002": "44077",
    "214003": "44107",
    "214004": "44107",
    "214005": "44144",
    "214006": "44144",
    "214007": "44202",
    "214008": "44202",
    "214009": "44207",
    "215001": "44028",
    "215002": "44028",
    "215003": "44028",
    "215004": "44028",
    "215005": "44048",
    "215006": "44048",
    "215007": "44082",
    "215008": "44082",
    "215009": "44096",
    "215010": "44096",
    "215011": "44096",
    "215012": "44115",
    "215013": "44115",
    "216001": "44004",
    "216002": "44011",
    "216003": "44011",
    "216004": "44034",
    "216005": "44034",
    "216006": "44060",
    "216007": "44060",
    "216008": "44104",
    "216009": "44104",
    "216010": "44147",
    "216011": "44147",
    "216012": "44163",
    "216013": "44163",
    "216014": "44213",
    "216015": "44213",
    "216016": "44213",
    "216017": "44222",
    "216018": "44222",
    "217001": "44003",
    "217002": "44003",
    "217003": "44003",
    "217004": "44003",
    "217005": "44003",
    "217006": "44160",
    "217007": "44160",
    "218001": "44008",
    "218002": "44029",
    "218003": "44029",
    "218004": "44029",
    "218005": "44169",
    "218006": "44169",
    "218007": "44169",
    "219001": "44079",
    "219002": "44079",
    "219003": "44084",
    "219004": "44084",
    "219005": "44084",
    "219006": "44141",
    "219007": "44141",
    "220001": "44140",
    "220002": "44212",
    "220003": "44212",
    "220004": "44212",
    "220005": "44212",
    "220006": "44212",
    "221001": "44016",
    "221002": "44032",
    "221003": "44032",
    "221004": "44108",
    "221005": "44108",
    "221006": "44117",
    "221007": "44117",
    "222001": "44037",
    "222002": "44037",
    "222003": "44070",
    "222004": "44070",
    "222005": "44070",
    "222006": "44071",
    "222007": "44071",
    "222008": "44071",
    "222009": "44159",
    "223001": "44022",
    "223002": "44022",
    "223003": "44063",
    "223004": "44063",
    "223005": "44063",
    "223006": "44063",
    "224001": "44043",
    "224002": "44043",
    "224003": "44043",
    "224004": "44043",
    "224005": "44064",
    "224006": "44064",
    "225001": "44088",
    "225002": "44088",
    "225003": "44100",
    "225004": "44100",
    "225005": "44165",
    "225006": "44173",
    "226001": "44002",
    "226002": "44002",
    "226003": "44127",
    "226004": "44142",
    "226005": "44216",
    "226006": "44216",
    "227001": "44014",
    "227002": "44014",
    "227003": "44014",
    "227004": "44102",
    "227005": "44102",
    "227006": "44223",
    "228001": "44041",
    "228002": "44041",
    "228003": "44041",
    "228004": "44041",
    "228005": "44130",
    "228006": "44130",
    "229001": "44083",
    "229002": "44083",
    "229003": "44155",
    "229004": "44155",
    "229005": "44174",
    "229006": "44174",
    "229007": "44188",
    "229008": "44188",
    "229009": "44188",
    "229010": "44188",
    "230001": "44081",
    "230002": "44081",
    "230003": "44081",
    "230004": "44156",
    "230005": "44156",
    "230006": "44206",
    "230007": "44206",
    "231001": "44087",
    "231002": "44087",
    "231003": "44087",
    "231004": "44087",
    "231005": "44090",
    "231006": "44119",
    "231007": "44119",
    "231008": "44157",
    "231009": "44157",
    "232001": "44021",
    "232002": "44021",
    "232003": "44059",
    "232004": "44059",
    "232005": "44178",
    "232006": "44178",
    "232007": "44181",
    "232008": "44181",
    "233001": "49069",
    "233002": "49069",
    "233003": "49172",
    "233004": "49172",
    "233005": "49270",
    "233006": "49270",
    "233007": "49320",
    "233008": "49320",
    "233009": "49349",
    "233010": "49349",
    "233011": "49360",
    "233012": "49360",
}

def execute(context):
    df_households, df_persons, df_trips, df_paths = context.stage("data.hts.edgt.raw")

    # Make copies
    df_households = pd.DataFrame(df_households, copy = True)
    df_persons = pd.DataFrame(df_persons, copy = True)
    df_trips = pd.DataFrame(df_trips, copy = True)
    df_paths = pd.DataFrame(df_paths, copy = True)

    # Construct new IDs for households, persons and trips (which are unique globally)
    df_households["household_id"] = np.arange(len(df_households))

    df_persons = pd.merge(
        df_persons, df_households[["MID", "household_id"]],
        on="MID"
    )
    df_persons["person_id"] = np.arange(len(df_persons))

    df_trips = pd.merge(
        df_trips, df_persons[["PID", "MID", "person_id", "household_id"]],
        on = ["PID", "MID"]
    )
    df_trips["trip_id"] = np.arange(len(df_trips))

    df_paths = pd.merge(
        df_paths, df_trips[["DID", "PID", "MID", "trip_id", "person_id", "household_id"]],
        on = ["DID", "PID", "MID"]
    )
    df_paths["path_id"] = np.arange(len(df_paths))

    # Trip flags
    df_trips = hts.compute_first_last(df_trips)

    # Weight
    df_households["household_weight"] = df_households["COEM"].astype(np.float)
    df_persons["person_weight"] = df_persons["COEP"].astype(np.float)

    # Clean age
    df_persons["age"] = df_persons["P4"].astype(np.int)

    # Clean sex
    df_persons.loc[df_persons["P2"] == 1, "sex"] = "male"
    df_persons.loc[df_persons["P2"] == 2, "sex"] = "female"
    df_persons["sex"] = df_persons["sex"].astype("category")

    # Household size
    df_households["household_size"] = df_persons.groupby("household_id").size()

    # Clean commune
    df_persons["commune_id"] = df_persons.replace({"ZONE": ZONES_MAP})["ZONE"].astype("category")
    df_households["commune_id"] = df_households.replace({"ZONE": ZONES_MAP})["ZONE"].astype("category")
    df_trips["origin_commune_id"] = df_trips.replace({"D3": ZONES_MAP})["D3"].astype("category")
    df_trips["destination_commune_id"] = df_trips.replace({"D7": ZONES_MAP})["D7"].astype("category")

    # Clean departement
    df_persons["departement_id"] = (df_persons["commune_id"].astype(int) / 1000).astype(int).astype(str).astype("category")
    df_households["departement_id"] = (df_households["commune_id"].astype(int) / 1000).astype(int).astype(str).astype("category")
    df_trips["origin_departement_id"] = (df_trips["origin_commune_id"].astype(int) / 1000).astype(int).astype(str).astype("category")
    df_trips["destination_departement_id"] = (df_trips["destination_commune_id"].astype(int) / 1000).astype(int).astype(str).astype("category")

    # Clean employment
    df_persons["employed"] = df_persons["P7"].astype('Float32').isin([1.0, 2.0])

    # Studies
    df_persons["studies"] = df_persons["P7"].astype('Float32').isin([3.0, 4.0, 5.0])

    # Number of vehicles
    df_households["number_of_vehicles"] = df_households["M5"] + df_households["M6"]
    df_households["number_of_vehicles"] = df_households["number_of_vehicles"].astype(np.int)
    df_households["number_of_bikes"] = df_households["M7"].astype(np.int)

    # License
    df_persons["has_license"] = (df_persons["P5"] == 1)

    # Has subscription
    df_persons["has_pt_subscription"] = True

    # Household income
    # df_households["income_class"] = df_households["REVENU"] - 1
    # df_households.loc[df_households["income_class"].isin([10.0, 11.0, np.nan]), "income_class"] = -1
    # df_households["income_class"] = df_households["income_class"].astype(np.int)

    df_households["income_class"] = 0

    # Trip purpose
    df_trips["following_purpose"] = "other"
    df_trips["preceding_purpose"] = "other"

    for purpose, category in PURPOSE_MAP.items():
        df_trips.loc[df_trips["D2A"].isin(category), "following_purpose"] = purpose
        df_trips.loc[df_trips["D5A"].isin(category), "preceding_purpose"] = purpose

    df_trips["following_purpose"] = df_trips["following_purpose"].astype("category")
    df_trips["preceding_purpose"] = df_trips["preceding_purpose"].astype("category")

    # Trip mode
    df_trips["mode"] = "walk"

    for mode, category in MODES_MAP.items():
        df_trips.loc[df_trips["MODP"].isin(category), "mode"] = mode

    df_trips["mode"] = df_trips["mode"].astype("category")

    # Further trip attributes
    df_trips["euclidean_distance"] = df_trips["DOIB"]

    # Trip times
    df_trips["departure_time"] = df_trips["D4A"] * 3600.0 + df_trips["D4B"] * 60.0
    df_trips["arrival_time"] = df_trips["D8A"] * 3600.0 + df_trips["D8B"] * 60.0
    df_trips = hts.fix_trip_times(df_trips)

    # Durations
    df_trips["trip_duration"] = df_trips["arrival_time"] - df_trips["departure_time"]
    hts.compute_activity_duration(df_trips)

    # Add weight to trips
    df_trips = pd.merge(
        df_trips, df_persons[["person_id", "person_weight"]], on = "person_id", how = "left"
    ).rename(columns = { "person_weight": "trip_weight" })
    df_persons["trip_weight"] = df_persons["person_weight"]

    # Chain length
    df_persons["number_of_trips"] = df_trips.groupby("person_id").size()

    # Passenger attribute
    df_persons["is_passenger"] = df_persons["person_id"].isin(
        df_trips[df_trips["mode"] == "car_passenger"]["person_id"].unique()
    )

    # Calculate consumption units
    hts.check_household_size(df_households, df_persons)
    df_households = pd.merge(df_households, hts.calculate_consumption_units(df_persons), on = "household_id")

    # Socioprofessional class
    df_persons["socioprofessional_class"] = df_persons["P9"].fillna(8).astype(int)

    # Drop people that have NaN departure or arrival times in trips
    # Filter for people with NaN departure or arrival times in trips
    f = df_trips["departure_time"].isna()
    f |= df_trips["arrival_time"].isna()

    f = df_persons["person_id"].isin(df_trips[f]["person_id"])

    nan_count = np.count_nonzero(f)
    total_count = len(df_persons)

    print("Dropping %d/%d persons because of NaN values in departure and arrival times" % (nan_count, total_count))

    df_persons = df_persons[~f]
    df_trips = df_trips[df_trips["person_id"].isin(df_persons["person_id"].unique())]
    df_households = df_households[df_households["household_id"].isin(df_persons["household_id"])]

    # Fix activity types (because of inconsistent EGT data and removing in the timing fixing step)
    hts.fix_activity_types(df_trips)

    return df_households, df_persons, df_trips

def calculate_income_class(df):
    assert "household_income" in df
    assert "consumption_units" in df

    return np.digitize(df["household_income"] / df["consumption_units"], INCOME_CLASS_BOUNDS, right = True)
